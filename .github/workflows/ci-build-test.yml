name: CI/CD - Build and Test

on:
  # Trigger em pull requests para branch main
  pull_request:
    branches: [ main, develop ]
  
  # Trigger em push para branches principais
  push:
    branches: [ main, develop ]
  
  # Permite execu√ß√£o manual via GitHub UI
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Pular execu√ß√£o de testes (use apenas para debug)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'
  MAVEN_OPTS: '-Xmx2g -XX:MaxMetaspaceSize=512m'
  MINIMUM_COVERAGE: 80

jobs:
  # Job 1: Valida√ß√£o de c√≥digo e testes dos microservi√ßos
  test-microservices:
    name: Test Microservices
    runs-on: ubuntu-latest
    
    strategy:
      # N√£o cancela outros jobs se um falhar (para ver todos os resultados)
      fail-fast: false
      matrix:
        service: [task-service, statistics-service, api-gateway]
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necess√°rio para an√°lise de cobertura comparativa
      
      - name: ‚òï Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'
      
      - name: üîç Verificar estrutura do servi√ßo
        run: |
          if [ ! -d "services/${{ matrix.service }}" ]; then
            echo "‚ùå Servi√ßo ${{ matrix.service }} n√£o encontrado!"
            exit 1
          fi
          echo "‚úÖ Servi√ßo ${{ matrix.service }} encontrado"
      
      - name: üß™ Executar testes unit√°rios e de integra√ß√£o
        if: ${{ github.event.inputs.skip_tests != 'true' }}
        working-directory: services/${{ matrix.service }}
        run: |
          echo "üöÄ Executando testes para ${{ matrix.service }}..."
          mvn clean test -B -V
      
      - name: üìä Gerar relat√≥rio de cobertura JaCoCo
        if: ${{ github.event.inputs.skip_tests != 'true' }}
        working-directory: services/${{ matrix.service }}
        run: |
          echo "üìä Gerando relat√≥rio de cobertura..."
          mvn jacoco:report -B
      
      - name: üéØ Verificar cobertura m√≠nima (${{ env.MINIMUM_COVERAGE }}%)
        if: ${{ github.event.inputs.skip_tests != 'true' }}
        working-directory: services/${{ matrix.service }}
        run: |
          echo "üéØ Validando cobertura m√≠nima de ${{ env.MINIMUM_COVERAGE }}%..."
          
          # Extrai percentual de cobertura do relat√≥rio JaCoCo
          if [ -f "target/site/jacoco/index.html" ]; then
            COVERAGE=$(grep -oP '<tfoot>.*?(\d+)%' target/site/jacoco/index.html | grep -oP '\d+' | head -1)
            
            if [ -z "$COVERAGE" ]; then
              echo "‚ö†Ô∏è N√£o foi poss√≠vel extrair percentual de cobertura"
              echo "Tentando m√©todo alternativo..."
              
              # M√©todo alternativo: parse do CSV
              if [ -f "target/site/jacoco/jacoco.csv" ]; then
                COVERED=$(awk -F, '{sum+=$5} END {print sum}' target/site/jacoco/jacoco.csv)
                TOTAL=$(awk -F, '{sum+=$6} END {print sum}' target/site/jacoco/jacoco.csv)
                COVERAGE=$(awk "BEGIN {printf \"%.0f\", ($COVERED/$TOTAL)*100}")
              fi
            fi
            
            echo "üìä Cobertura de testes: ${COVERAGE}%"
            echo "üéØ Cobertura m√≠nima: ${{ env.MINIMUM_COVERAGE }}%"
            
            if [ -n "$COVERAGE" ] && [ "$COVERAGE" -ge "${{ env.MINIMUM_COVERAGE }}" ]; then
              echo "‚úÖ Cobertura APROVADA (${COVERAGE}% >= ${{ env.MINIMUM_COVERAGE }}%)"
            else
              echo "‚ùå Cobertura INSUFICIENTE (${COVERAGE}% < ${{ env.MINIMUM_COVERAGE }}%)"
              echo ""
              echo "üîç Recomenda√ß√µes:"
              echo "  - Adicione mais testes unit√°rios"
              echo "  - Revise a cobertura de branches"
              echo "  - Verifique m√©todos n√£o testados"
              exit 1
            fi
          else
            echo "‚ö†Ô∏è Relat√≥rio JaCoCo n√£o encontrado em target/site/jacoco/index.html"
            echo "Verificando se os testes foram executados..."
            
            if [ -d "target/test-classes" ]; then
              echo "‚úÖ Testes compilados, mas relat√≥rio JaCoCo ausente"
              echo "Considerando build v√°lido, mas sem valida√ß√£o de cobertura"
            else
              echo "‚ùå Testes n√£o foram executados"
              exit 1
            fi
          fi
      
      - name: üìà Upload relat√≥rio de cobertura (Artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ matrix.service }}
          path: services/${{ matrix.service }}/target/site/jacoco/
          retention-days: 30
      
      - name: üìã Upload resultados de testes (Artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.service }}
          path: |
            services/${{ matrix.service }}/target/surefire-reports/
            services/${{ matrix.service }}/target/failsafe-reports/
          retention-days: 30
  
  # Job 2: Build dos microservi√ßos (s√≥ executa se testes passarem)
  build-microservices:
    name: Build Microservices
    needs: test-microservices
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        service: [task-service, statistics-service, api-gateway]
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: ‚òï Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'
      
      - name: üèóÔ∏è Build do servi√ßo (sem testes)
        working-directory: services/${{ matrix.service }}
        run: |
          echo "üèóÔ∏è Compilando ${{ matrix.service }}..."
          mvn clean package -DskipTests -B -V
      
      - name: üì¶ Upload JAR compilado (Artifact)
        uses: actions/upload-artifact@v4
        with:
          name: jar-${{ matrix.service }}
          path: services/${{ matrix.service }}/target/*.jar
          retention-days: 7
  
  # Job 3: Build do mon√≥lito (legado)
  build-monolith:
    name: Build Monolith (Legacy)
    needs: test-microservices
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: ‚òï Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'
      
      - name: üèóÔ∏è Build do mon√≥lito (sem testes)
        run: |
          echo "üèóÔ∏è Compilando mon√≥lito..."
          mvn clean package -DskipTests -B -V
      
      - name: üì¶ Upload JAR do mon√≥lito (Artifact)
        uses: actions/upload-artifact@v4
        with:
          name: jar-monolith
          path: target/*.jar
          retention-days: 7
  
  # Job 4: Relat√≥rio consolidado
  coverage-report:
    name: Coverage Report Summary
    needs: test-microservices
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: üì• Download relat√≥rios de cobertura
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-report-*
          path: coverage-reports
      
      - name: üìä Gerar resumo consolidado
        run: |
          echo "# üìä Relat√≥rio de Cobertura de Testes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Microservi√ßos Analisados" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Servi√ßo | Status | Cobertura |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|-----------|" >> $GITHUB_STEP_SUMMARY
          
          for service in task-service statistics-service api-gateway; do
            REPORT_FILE="coverage-reports/coverage-report-${service}/index.html"
            
            if [ -f "$REPORT_FILE" ]; then
              COVERAGE=$(grep -oP '<tfoot>.*?(\d+)%' "$REPORT_FILE" | grep -oP '\d+' | head -1 || echo "N/A")
              
              if [ "$COVERAGE" != "N/A" ] && [ "$COVERAGE" -ge "${{ env.MINIMUM_COVERAGE }}" ]; then
                STATUS="‚úÖ Aprovado"
              else
                STATUS="‚ùå Reprovado"
              fi
              
              echo "| ${service} | ${STATUS} | ${COVERAGE}% |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| ${service} | ‚ö†Ô∏è N√£o encontrado | N/A |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cobertura m√≠nima exigida:** ${{ env.MINIMUM_COVERAGE }}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "üîç **Dica:** Baixe os artefatos para visualizar os relat√≥rios HTML completos" >> $GITHUB_STEP_SUMMARY

  # Job 5: Status final consolidado
  status-check:
    name: CI Status Check
    needs: [test-microservices, build-microservices, build-monolith]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ‚úÖ Verificar status geral
        run: |
          if [[ "${{ needs.test-microservices.result }}" == "success" ]] && \
             [[ "${{ needs.build-microservices.result }}" == "success" ]] && \
             [[ "${{ needs.build-monolith.result }}" == "success" ]]; then
            echo "‚úÖ Todos os jobs foram conclu√≠dos com sucesso!"
            echo "üéâ Build APROVADO"
            exit 0
          else
            echo "‚ùå Um ou mais jobs falharam:"
            echo "  - Testes: ${{ needs.test-microservices.result }}"
            echo "  - Build Microservices: ${{ needs.build-microservices.result }}"
            echo "  - Build Monolith: ${{ needs.build-monolith.result }}"
            echo ""
            echo "üîç Verifique os logs acima para detalhes"
            exit 1
          fi
